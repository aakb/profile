From c9ac0b50df1543767f3d453f42a4976c718ca7a9 Mon Sep 17 00:00:00 2001
From: Thomas Johansen <thsj@aarhus.dk>
Date: Mon, 22 Sep 2014 14:15:34 +0200
Subject: [PATCH] patching

---
 Loop_Saml2_AuthnRequest.php | 107 ++++++++++++++++++++++++++++++++++++++++++++
 saml_sp.module              |   2 +-
 2 files changed, 108 insertions(+), 1 deletion(-)
 create mode 100644 Loop_Saml2_AuthnRequest.php

diff --git a/Loop_Saml2_AuthnRequest.php b/Loop_Saml2_AuthnRequest.php
new file mode 100644
index 0000000..eeccf7c
--- /dev/null
+++ b/Loop_Saml2_AuthnRequest.php
@@ -0,0 +1,107 @@
+<?php
+
+/**
+ * SAML 2 Authentication Request
+ *
+ */
+class Loop_Saml2_AuthnRequest
+{
+
+    /**
+     * Object that represents the setting info
+     * @var OneLogin_Saml2_Settings
+     */
+    protected $_settings;
+
+    /**
+     * SAML AuthNRequest string
+     * @var string
+     */
+    private $_authnRequest;
+
+    /**
+     * SAML AuthNRequest ID.
+     * @var string
+     */
+    private $_id;
+
+    /**
+     * Constructs the AuthnRequest object.
+     *
+     * @param OneLogin_Saml2_Settings $settings Settings
+     */
+    public function __construct(OneLogin_Saml2_Settings $settings)
+    {
+        $this->_settings = $settings;
+
+        $spData = $this->_settings->getSPData();
+        $idpData = $this->_settings->getIdPData();
+        $security = $this->_settings->getSecurityData();
+
+        $id = OneLogin_Saml2_Utils::generateUniqueID();
+        $issueInstant = OneLogin_Saml2_Utils::parseTime2SAML(time());
+        
+        $nameIDPolicyFormat = $spData['NameIDFormat'];
+        if (isset($security['wantNameIdEncrypted']) && $security['wantNameIdEncrypted']) {
+            $nameIDPolicyFormat = OneLogin_Saml2_Constants::NAMEID_ENCRYPTED;
+        }
+
+        $providerNameStr = '';
+        $organizationData = $settings->getOrganization();
+        if (!empty($organizationData)) {
+            $langs = array_keys($organizationData);
+            if (in_array('en-US', $langs)) {
+                $lang = 'en-US';
+            } else {
+                $lang = $langs[0];
+            }
+            if (isset($organizationData[$lang]['displayname']) && !empty($organizationData[$lang]['displayname'])) {
+                $providerNameStr = <<<PROVIDERNAME
+    ProviderName="{$organizationData[$lang]['displayname']}" 
+PROVIDERNAME;
+            }
+        }
+
+        $request = <<<AUTHNREQUEST
+<samlp:AuthnRequest
+    xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
+    xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
+    ID="$id"
+    Version="2.0"
+{$providerNameStr}
+    IssueInstant="$issueInstant"
+    Destination="{$idpData['singleSignOnService']['url']}"
+    ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
+    AssertionConsumerServiceURL="{$spData['assertionConsumerService']['url']}">
+    <saml:Issuer>{$spData['entityId']}</saml:Issuer>
+    <samlp:NameIDPolicy
+        Format="{$nameIDPolicyFormat}"
+        AllowCreate="true" />
+</samlp:AuthnRequest>
+AUTHNREQUEST;
+
+        $this->_id = $id;
+        $this->_authnRequest = $request;
+    }
+
+    /**
+     * Returns deflated, base64 encoded, unsigned AuthnRequest.
+     *
+     */
+    public function getRequest()
+    {
+        $deflatedRequest = gzdeflate($this->_authnRequest);
+        $base64Request = base64_encode($deflatedRequest);
+        return $base64Request;
+    }
+
+    /**
+     * Returns the AuthNRequest ID.
+     *
+     * @return string
+     */
+    public function getId()
+    {
+        return $this->_id;
+    }
+}
diff --git a/saml_sp.module b/saml_sp.module
index 22fee0f..6fa95fa 100755
--- a/saml_sp.module
+++ b/saml_sp.module
@@ -286,7 +286,7 @@ function saml_sp_start($idp, $callback) {
   $settings = saml_sp__get_settings($idp);
   // Creating Saml2 Settings object
   $saml_settings = new OneLogin_Saml2_Settings($settings);
-  $auth_request = new OneLogin_Saml2_AuthnRequest($saml_settings);
+  $auth_request = new Loop_Saml2_AuthnRequest($saml_settings);
   $saml_request = $auth_request->getRequest();
 
   $parameters = array('SAMLRequest' => $saml_request);
-- 
1.9.0


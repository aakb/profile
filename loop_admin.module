<?php
/**
 * @file
 * Alter paths and build statistics for users.
 */

include_once 'loop_admin.features.inc';

// Defines the number of rows to show in the statistics tables.
define('LOOP_ADMIN_STATISTICS_LIMIT', 5);

/**
 * Implements hook_admin_paths_alter().
 *
 * Setup permissions for user pages and create user pages.
 */
function loop_admin_admin_paths_alter(&$paths) {
  // Treat all user pages as not administrative.
  $paths['user/*'] = FALSE;
  $paths['admin/people/create'] = FALSE;
}

/**
 * Implements hook_FORM_ID_form_alter().
 *
 * Add full name to author information tab.
 */
function loop_admin_form_post_node_form_alter(&$form, &$form_state) {
  $account = user_load($form['uid']['#value']);

  $name = _loop_admin_generate_full_name($account);
  if (!$name) {
    $name = t('Not set');
  }
  $form['author']['name']['#title'] .= ' fullname: <span>' . $name . '</span>';
}

/**
 * Implements hook_menu().
 */
function loop_admin_menu() {
  $items = array();

  $items['editor/dashboard/user-statistics'] = array(
    'title' => 'LOOP User statistics',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_loop_admin_user_statistics_form'),
    'access arguments' => array('access user profiles'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function loop_admin_theme($existing, $type, $theme, $path) {
  return array(
    'loop_admin_stats_post_count' => array(
      'variables' => array(
        'post_count' => 0,
        'comment_count' => 0,
      ),
      'template' => 'templates/loop_admin_stats_post_count',
    ),
  );
}

/**
 * Menu callback that generates the table.
 *
 * @throws Exception
 */
function _loop_admin_user_statistics_form($form, &$form_state) {
  // Check for filter values.
  $filter = array();
  if (isset($form_state['input']['filter']['start_date']['date'])) {
    $filter['date']['start'] = strtotime($form_state['input']['filter']['start_date']['date']);
  }

  if (isset($form_state['input']['filter']['end_date']['date'])) {
    $filter['date']['end'] = strtotime($form_state['input']['filter']['end_date']['date']);
  }

  // Build filter field set.
  $form['filter'] = array(
    '#type' => 'fieldset',
    '#title' => t('Filter list'),
    '#collapsible' => TRUE,
    '#tree' => TRUE,
  );

  $form['filter']['start_date'] = array(
    '#type' => 'date_popup',
    '#title' => t('Start'),
    '#required' => TRUE,
    '#date_format' => 'd-m-Y',
    '#date_label_position' => 'none',
    '#attributes' => array('autocomplete' => 'off'),
    '#default_value' => isset($filter['date']['start']) ? date('Y-m-d H:i:s', $filter['date']['start']) :  '',
  );

  $form['filter']['end_date'] = array(
    '#type' => 'date_popup',
    '#title' => t('End'),
    '#required' => TRUE,
    '#date_format' => 'd-m-Y',
    '#date_label_position' => 'none',
    '#attributes' => array('autocomplete' => 'off'),
    '#default_value' => isset($filter['date']['end']) ? date('Y-m-d H:i:s', $filter['date']['end']) : '',
  );

  // Add Ajax submit button (as form submits to own address and loads twice,
  // hence values are empty on load).
  $form['filter']['submit'] = array(
    '#type' => 'button',
    '#value' => t('Filter'),
    '#name' => 'filter-submit',
    '#ajax' => array(
      'callback' => '_loop_admin_user_statistics_ajax_callback',
      'wrapper' => 'replace-stats',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );

  // Add javascript to handle reset of data-pickers on ajax completed events to
  // clear out the date filters.
  $form['#attached']['js'] = array(
    drupal_get_path('module', 'loop_admin') . '/js/loop_admin.js',
  );

  // Add reset button to clear the sessions filter.
  $form['filter']['reset'] = array(
    '#type' => 'button',
    '#value' => t('Reset'),
    '#name' => 'filter-reset',
    '#ajax' => array(
      'callback' => '_loop_admin_user_statistics_reset_ajax_callback',
      'wrapper' => 'replace-stats',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );

  // Add wrapper to replace on filter.
  $form['stats'] = array(
    '#tree' => TRUE,
    '#prefix' => '<div id="replace-stats">',
    '#suffix' => '</div>',
  );

  // Add field-set for content stats.
  $form['stats']['content'] = array(
    '#type' => 'fieldset',
    '#title' => t('Content statistics'),
    '#collapsible' => TRUE,
    '#tree' => TRUE,
  );

  // Add basic count of posts and comments.
  _loop_admin_content_statistics_total_count_element($form, $filter);

  // Add top answers.
  _loop_admin_content_statistics_answers_count_element($form, $filter);


  // Add field-set for user stats.
  $form['stats']['user'] = array(
    '#type' => 'fieldset',
    '#title' => t('User statistics'),
    '#collapsible' => TRUE,
    '#tree' => TRUE,
  );

  return $form;
}

/**
 * Ajax callback for the filter form.
 */
function _loop_admin_user_statistics_ajax_callback($form, $form_state) {
  $form = _loop_admin_user_statistics_form($form, $form_state);
  return $form['stats'];
}

/**
 * Ajax callback for the reset filter button.
 */
function _loop_admin_user_statistics_reset_ajax_callback($form, $form_state) {
  // Remove values form form state.
  unset($form_state['input']['filter']);

  // Rebuild the form.
  return _loop_admin_user_statistics_ajax_callback($form, $form_state);
}


/**
 * Build query to find statistics information.
 *
 * @param array $filter
 *   The different values to filter on.
 *
 * @return SelectQuery
 *   Query to run against the database.
 */
function _loop_admin_user_statistics_query($filter = array()) {
  // Start with the comment table.
  $query = db_select('comment', 'comment');

  // Count comments for a user.
  $query->addExpression('COUNT(comment.cid)', 'comments');

  // Add user information.
  $query->rightJoin('users', 'u', 'comment.uid = u.uid');
  $query->addField('u', 'uid', 'uid');
  $query->addField('u', 'name', 'username');

  // Add username.
  $query->join('field_data_field_first_name', 'fn', 'fn.entity_id = u.uid');
  $query->join('field_data_field_last_name', 'ln', 'ln.entity_id = u.uid');
  $query->addField('fn', 'field_first_name_value', 'firstname');
  $query->addField('ln', 'field_last_name_value', 'lastname');
  $query->addExpression("CONCAT_WS(' ', fn.field_first_name_value, ln.field_last_name_value)", 'fullname');

  // Group by each user.
  $query->groupBy('u.uid');

  // Get thumbs up.
  if (isset($filter['date'])) {
    $query->addExpression("(SELECT count(*) FROM comment c JOIN flagging f ON c.cid = f.entity_id WHERE c.uid = u.uid AND timestamp >= :start_date AND timestamp <= :end_date)", 'thumbs', array('start_date' => $filter['date']['start'], 'end_date' => $filter['date']['end']));
  }
  else {
    $query->addExpression("(SELECT count(*) FROM comment c JOIN flagging f ON c.cid = f.entity_id WHERE c.uid = u.uid)", 'thumbs');
  }

  // Get most accepted answers.
  if (isset($filter['date'])) {
    $query->addExpression("(SELECT count(*) FROM (SELECT c.uid, MAX(fc.count) FROM node n JOIN comment c ON n.nid = c.nid JOIN flag_counts fc ON c.cid = fc.entity_id JOIN flagging f ON f.entity_id = c.cid WHERE fc.entity_type = 'comment' AND f.timestamp >= :start_date AND f.timestamp <= :end_date GROUP BY n.nid) AS count WHERE count.uid = u.uid)", 'accepted', array('start_date' => $filter['date']['start'], 'end_date' => $filter['date']['end']));
  }
  else {
    $query->addExpression("(SELECT count(*) FROM (SELECT c.uid, MAX(fc.count) FROM node n JOIN comment c ON n.nid = c.nid JOIN flag_counts fc ON c.cid = fc.entity_id WHERE fc.entity_type = 'comment' GROUP BY n.nid) AS count WHERE count.uid = u.uid)", 'accepted');
  }

  // Filter the whole query on date.
  if (isset($filter['date'])) {
    $query->where("comment.cid IN (SELECT entity_id FROM flagging f WHERE f.entity_type = 'comment' AND f.timestamp >= :start_date AND f.timestamp <= :end_date)", array('start_date' => $filter['date']['start'], 'end_date' => $filter['date']['end']));
  }

  return $query;
}

/**
 * Wrapper function to add top list of answers in posts to the form.
 *
 * @param $form
 *   Form to add the table to.
 * @param array $filter
 *   The different values to filter on.
 */
function _loop_admin_content_statistics_answers_count_element(&$form, $filter = array()) {
  // Get statistics.
  $result = _loop_admin_content_statistics_answers_count($filter);

  // Define headers
  $header = array(
    array('data' => t('The top @limit most answered posts', array('@limit' => LOOP_ADMIN_STATISTICS_LIMIT))),
    array('data' => t('Count')),
  );

  // Looping to fill the table rows.
  $rows = array();
  foreach ($result as $row) {
    // Fill the table rows.
    $rows[] = array(
      l($row->title, 'node/' . $row->nid),
      $row->count,
    );
  }

  // Theme tables.
  $form['stats']['content']['top_answers'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('Table has no row!'),
  );
}

/**
 * Get list of posts order by the number of answers a post got.
 *
 * @param array $filter
 *   The different values to filter on.
 *
 * @return DatabaseStatementInterface|null
 *   The database results or NULL if no results.
 */
function _loop_admin_content_statistics_answers_count($filter = array()) {
  // Select all "post" nodes.
  $query = db_select('node', 'n')
    ->fields('n', array('nid', 'title'))
    ->condition('n.type', 'post', '=');

  // Join comments on the table.
  $query->join('comment', 'c', 'n.nid = c.nid');

  // Count the number of answers.
  $query->addExpression('COUNT(1)', 'count');

  // Filter the query on date.
  if (isset($filter['date'])) {
    $query->condition('n.created', $filter['date']['start'], '>=')
      ->condition('n.created', $filter['date']['end'], '<=');
  }

  // Group by node id's and order by there count.
  $query->groupBy('n.nid');
  $query->orderBy('count', 'desc');

  // Limit the number of rows.
  $query->range(0, LOOP_ADMIN_STATISTICS_LIMIT);

  // Execute query.
  return $query->execute();
}

/**
 * Builds the new questions and answers block.
 *
 * @param $form
 *   The form to insert the block into.
 *
 * @param array $filter
 *   The different values to filter on.
 */
function _loop_admin_content_statistics_total_count_element(&$form, $filter = array()) {
  $form['stats']['content']['post_count'] = array(
    '#theme' => 'loop_admin_stats_post_count',
    '#post_count' => _loop_admin_content_statistics_post_count($filter),
    '#comment_count' => _loop_admin_content_statistics_comment_count($filter),
  );
}

/**
 * Count the number of posts in the database.
 *
 * @param array $filter
 *   The different values to filter on.
 *
 * @return int
 */
function _loop_admin_content_statistics_post_count($filter = array()) {
  // Use the node table to get node with type "post".
  $query = db_select('node', 'n')
    ->condition('n.type', 'post', '=');

  // Filter the query on date.
  if (isset($filter['date'])) {
    $query->condition('n.created', $filter['date']['start'], '>=')
      ->condition('n.created', $filter['date']['end'], '<=');
  }

  // Return the number of rows (the count).
  return $query->countQuery()->execute()->fetchField();
}

/**
 * Count the number of comments to posts in the database.
 *
 * @param array $filter
 *   The different values to filter on.
 *
 * @return int
 */
function _loop_admin_content_statistics_comment_count($filter = array()) {
  // Use the node table to get node with type "post".
  $query = db_select('node', 'n')
    ->condition('n.type', 'post', '=');

  // Join comments on the table.
  $query->join('comment', 'c', 'n.nid = c.nid');

  // Filter the query on date.
  if (isset($filter['date'])) {
    $query->condition('n.created', $filter['date']['start'], '>=')
      ->condition('n.created', $filter['date']['end'], '<=');
  }

  // Return the number of rows (the count).
  return $query->countQuery()->execute()->fetchField();
}

/**
 * Get full name from an user account.
 *
 * @param StdClass $account
 *   Drupal user account.
 *
 * @return string
 *   The users full name.
 */
function _loop_admin_generate_full_name($account) {
  $name = '';
  if (isset($account->field_first_name['und'][0]['safe_value'])) {
    $name = '' . $account->field_first_name['und'][0]['safe_value'];
    if (isset($account->field_last_name['und'][0]['safe_value'])) {
      $name .= ' ' . $account->field_last_name['und'][0]['safe_value'];

    }
  }

  return $name;
}
